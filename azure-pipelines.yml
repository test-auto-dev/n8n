trigger:
  branches:
    include:
      - main

variables:
  resourceGroup: "my-rg"
  containerAppName: "my-test-services"
  environmentName: "my-env"
  location: "eastus"
  storageAccountName: "n8nstorageacct"
  fileShareName: "n8nfilestorage"

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    displayName: "ðŸš€ Deploy persistent n8n to Azure Container Apps"
    inputs:
      azureSubscription: "My-Azure-Service-Connection"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -ex

        RESOURCE_GROUP="$(resourceGroup)"
        CONTAINER_APP_NAME="$(containerAppName)"
        ENVIRONMENT_NAME="$(environmentName)"
        LOCATION="$(location)"
        STORAGE_ACCOUNT_NAME="$(storageAccountName)"
        FILE_SHARE_NAME="$(fileShareName)"

        echo "ðŸ”¹ Creating resource group..."
        az group create --name $RESOURCE_GROUP --location $LOCATION

        echo "ðŸ”¹ Creating Container Apps environment..."
        az containerapp env create \
          --name $ENVIRONMENT_NAME \
          --resource-group $RESOURCE_GROUP \
          --location $LOCATION || true

        echo "ðŸ”¹ Creating storage account..."
        az storage account create \
          --name $STORAGE_ACCOUNT_NAME \
          --resource-group $RESOURCE_GROUP \
          --location $LOCATION \
          --sku Standard_LRS || true

        echo "ðŸ”¹ Creating file share..."
        az storage share create \
          --name $FILE_SHARE_NAME \
          --account-name $STORAGE_ACCOUNT_NAME || true

        echo "ðŸ”¹ Deploying n8n container..."
        az containerapp create \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --environment $ENVIRONMENT_NAME \
          --image n8nio/n8n:latest \
          --target-port 5678 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 1 \
          --env-vars \
            N8N_BASIC_AUTH_ACTIVE=true \
            N8N_BASIC_AUTH_USER=admin \
            N8N_BASIC_AUTH_PASSWORD=SuperStrongPassword@123 \
            N8N_USER_MANAGEMENT_DISABLED=false \
            N8N_ENCRYPTION_KEY=mySuperSecretKey123 \
            N8N_PROTOCOL=https \
            N8N_PORT=5678 \
            N8N_PATH=/ \
            WEBHOOK_URL="https://my-test-services.${LOCATION}.azurecontainerapps.io/" \
            TZ=Asia/Kolkata \
          --query properties.configuration.ingress.fqdn -o tsv || true

        echo "ðŸ”¹ Fetching public URL..."
        fqdn=$(az containerapp show --name $CONTAINER_APP_NAME --resource-group $RESOURCE_GROUP --query properties.configuration.ingress.fqdn -o tsv)
        echo "âœ… Your n8n instance is live at: https://$fqdn"

        echo "ðŸ”¹ Updating n8n container with correct WEBHOOK_URL..."
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --set-env-vars WEBHOOK_URL=https://$fqdn \
          --query properties.configuration.ingress.fqdn -o tsv || true

        echo "âœ… Deployment complete. Access n8n at: https://$fqdn"
