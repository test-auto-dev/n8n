trigger:
  branches:
    include:
      - main

variables:
  resourceGroup: "my-rg"
  containerAppName: "my-n8n"
  environmentName: "my-env"
  location: "eastus"
  storageAccountName: "n8nstorageacct"
  fileShareName: "n8nfilestorage"

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: "My-Azure-Service-Connection" # Replace with your service connection name
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "Creating resource group..."
        az group create --name $resourceGroup --location $location

        echo "Creating Container Apps environment..."
        az containerapp env create \
          --name $environmentName \
          --resource-group $resourceGroup \
          --location $location || true

        echo "Creating storage account..."
        az storage account create \
          --name $storageAccountName \
          --resource-group $resourceGroup \
          --location $location \
          --sku Standard_LRS || true

        echo "Creating file share..."
        az storage share create \
          --name $fileShareName \
          --account-name $storageAccountName || true

        echo "Deploying n8n container app..."
        az containerapp create \
          --name $containerAppName \
          --resource-group $resourceGroup \
          --environment $environmentName \
          --image n8nio/n8n:latest \
          --target-port 5678 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 1 \
          --env-vars \
            N8N_USER_MANAGEMENT_DISABLED=false \
            N8N_BASIC_AUTH_ACTIVE=false \
            N8N_ENCRYPTION_KEY=mySuperSecretKey123 \
            N8N_PROTOCOL=https \
            N8N_PORT=5678 \
            TZ=Asia/Kolkata \
          --volume-mounts "/home/node/.n8n=n8n-data" \
          --secrets none \
          --registry-identity system \
          --query properties.configuration.ingress.fqdn \
          -o tsv || true

        echo "Deployment complete. Fetching URL..."
        fqdn=$(az containerapp show --name $containerAppName --resource-group $resourceGroup --query properties.configuration.ingress.fqdn -o tsv)
        echo "âœ… Access your n8n instance at: https://$fqdn"
