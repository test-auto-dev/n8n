trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: DockerInstaller@0
  displayName: Install Docker

- script: |
    docker --version
    docker compose version
  displayName: Verify Docker Installation

- script: |
    docker compose up -d
  displayName: Run n8n using Docker Compose

- script: |
    docker ps
    PORT=$(docker inspect $(docker ps -q) --format='{{(index (index .NetworkSettings.Ports "5678/tcp") 0).HostPort}}')
    echo "##vso[task.setvariable variable=N8N_DYNAMIC_PORT]$PORT"
    echo "n8n is running on port $PORT"
  displayName: Get Dynamic Port from Docker

- script: |
    echo "Access n8n on localhost:${N8N_DYNAMIC_PORT}"
  displayName: Use Dynamic Port
