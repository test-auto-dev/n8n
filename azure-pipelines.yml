trigger:
  branches:
    include:
      - main

variables:
  resourceGroup: "my-rg"
  containerAppName: "my-n8n"
  environmentName: "my-env"
  location: "eastus"
  storageAccountName: "n8nstorageacct"
  fileShareName: "n8nfilestorage"

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: "My-Azure-Service-Connection" # ðŸ”¹ Replace with your actual Azure service connection name
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "ðŸ”¹ Creating resource group (if not exists)..."
        az group create --name $resourceGroup --location $location

        echo "ðŸ”¹ Creating Container Apps environment (if not exists)..."
        az containerapp env create \
          --name $environmentName \
          --resource-group $resourceGroup \
          --location $location || true

        echo "ðŸ”¹ Creating storage account (if not exists)..."
        az storage account create \
          --name $storageAccountName \
          --resource-group $resourceGroup \
          --location $location \
          --sku Standard_LRS || true

        echo "ðŸ”¹ Getting storage account key..."
        storageKey=$(az storage account keys list --account-name $storageAccountName --resource-group $resourceGroup --query "[0].value" -o tsv)

        echo "ðŸ”¹ Creating file share (for persistent n8n data)..."
        az storage share create \
          --name $fileShareName \
          --account-name $storageAccountName \
          --account-key $storageKey || true

        echo "ðŸ”¹ Deploying n8n container app..."
        az containerapp create \
          --name $containerAppName \
          --resource-group $resourceGroup \
          --environment $environmentName \
          --image n8nio/n8n:latest \
          --target-port 5678 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 1 \
          --env-vars \
            N8N_USER_MANAGEMENT_DISABLED=false \
            N8N_BASIC_AUTH_ACTIVE=false \
            N8N_ENCRYPTION_KEY=mySuperSecretKey123 \
            N8N_PROTOCOL=https \
            N8N_PORT=5678 \
            TZ=Asia/Kolkata \
            WEBHOOK_URL=https://my-test-services.gentlewater-3c4722ee.eastus.azurecontainerapps.io/ \
          --volume-mounts "/home/node/.n8n=n8n-data" \
          --storage-account-name $storageAccountName \
          --storage-account-key $storageKey \
          --file-share-name $fileShareName \
          -o none || true

        echo "ðŸ”¹ Fetching public URL..."
        fqdn=$(az containerapp show --name $containerAppName --resource-group $resourceGroup --query properties.configuration.ingress.fqdn -o tsv)
        echo "âœ… Your n8n instance is live at: https://$fqdn"

        echo "ðŸ”¹ Updating WEBHOOK_URL to match actual FQDN..."
        az containerapp update \
          --name $containerAppName \
          --resource-group $resourceGroup \
          --set-env-vars WEBHOOK_URL=https://$fqdn/
